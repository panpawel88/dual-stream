# DualStream Video Player Testing System

A comprehensive testing framework for validating video playback, switching accuracy, and performance benchmarks using synthetic test videos with embedded frame numbers and visual patterns.

## Overview

The testing system leverages the existing synthetic test videos (generated by `generate_test_videos.bat`) which contain:
- **Frame numbers** embedded as text overlays
- **Colored corner markers** for alignment validation
- **Predictable motion patterns** (sine/cosine based) for object tracking
- **Multiple resolutions and frame rates** for performance testing

## Test Types

### 1. Frame Validation Tests
Validate frame accuracy and visual patterns:
- Extract frame numbers from rendered frames
- Detect colored corner markers (yellow, green, blue, magenta)
- Validate moving object positions against mathematical expectations
- Check for frame drops or duplicates

### 2. Switching Accuracy Tests
Test video switching behavior for all algorithms:
- **Immediate Algorithm**: Measures seek latency and frame accuracy
- **Keyframe-Sync Algorithm**: Validates keyframe alignment and timing
- **Predecoded Algorithm**: Tests zero-latency switching and memory usage

### 3. Performance Benchmarks
Monitor system performance across different configurations:
- Frame rate consistency and stability
- Memory usage patterns
- CPU/GPU utilization
- Switching latency measurements
- Stress testing with high-resolution videos

## Quick Start

### Generate Test Videos
```bash
# Generate all test videos (HD, 4K, 8K at various frame rates)
generate_test_videos.bat
```

### Build with Testing System
```bash
# Build project with test system enabled
build.bat --cmake
```

### Run All Tests
```bash
# Run comprehensive test suite
run_tests.bat
```

### Run Specific Tests
```bash
# Run only frame validation tests
build/bin/Release/test_runner.exe --suite frame_validation_basic --verbose

# Run switching accuracy tests
build/bin/Release/test_runner.exe --suite switching_accuracy --verbose

# Run performance benchmarks
build/bin/Release/test_runner.exe --suite performance_benchmarks --verbose

# Run a specific test
build/bin/Release/test_runner.exe --test hd_30fps_performance --debug
```

## Test Configuration

Tests are configured via `test_config.json`:

```json
{
  "test_suites": [
    {
      "name": "frame_validation_basic",
      "tests": [
        {
          "name": "short_videos_frame_numbers",
          "video_paths": [
            "test_videos/short_a_red_fade.mp4",
            "test_videos/short_b_blue_pulse.mp4"
          ],
          "algorithm": "immediate",
          "duration_seconds": 3,
          "test_type": "frame_validation"
        }
      ]
    }
  ]
}
```

## Test Video Patterns

### Moving Square Pattern (`video1_red_square.mp4`)
- **Background**: Red
- **Object**: White 100×100 square
- **Motion**: `x = 50 + 200*sin(2πt)`, `y = 100 + 100*sin(2πt)`
- **Frame Text**: "Video 1 - Frame N"

### Moving Circle Pattern (`video2_blue_circle.mp4`)  
- **Background**: Blue
- **Object**: Yellow circle (80×80)
- **Motion**: `x = 100 + 200*cos(2πt)`, `y = 150 + 150*sin(2πt)`
- **Frame Text**: "Video 2 - Frame N"

### Bouncing Ball Pattern (`video4_bouncing_ball.mp4`)
- **Background**: Green
- **Object**: Red square (50×50) 
- **Motion**: `x = 50 + |200*sin(πt)|`, `y = 50 + |150*sin(1.5πt)|`
- **Frame Text**: "Video 4 - Frame N - FPS: 30"

### Color Gradient (`video3_gradient.mp4`)
- **Pattern**: Animated color gradient
- **Motion**: `hue = 360*t/8` (full hue cycle over 8 seconds)
- **Frame Text**: "Video 3 H265 - Frame N"

## Architecture

### Core Components

- **TestRunner**: Main test orchestrator and execution engine
- **FrameValidator**: Frame analysis and pattern validation 
- **SwitchingValidator**: Algorithm-specific switching behavior tests
- **PerformanceBenchmark**: Resource utilization and performance monitoring

### Key Features

- **JSON Configuration**: Flexible test suite configuration
- **Multi-Algorithm Testing**: Tests all three switching strategies
- **Resolution Matrix**: HD/4K/8K performance testing
- **Frame Rate Validation**: 30fps/60fps consistency checking
- **Visual Regression**: Pattern matching and object tracking
- **Memory Profiling**: Algorithm-specific memory usage analysis

## Expected Results

### Frame Validation
- Frame numbers should be sequential and match timestamps
- Corner markers should always be present and correctly positioned
- Moving objects should follow mathematical motion equations within tolerance

### Switching Accuracy
- **Immediate**: Latency 1-5ms, seeks to current playback time
- **Keyframe-Sync**: Variable latency (0-2000ms), switches only at keyframes
- **Predecoded**: Near 0ms latency, perfect frame synchronization

### Performance Benchmarks
- **HD 30fps**: Consistent 30fps delivery, <100MB memory usage
- **4K 60fps**: Consistent 60fps delivery, hardware acceleration utilized
- **8K 60fps**: Stress test limits, acceptable frame drops under high load

## Output and Reporting

Test results are saved to `test_results.json` with detailed metrics:

```json
{
  "test_results": [
    {
      "test_name": "hd_30fps_performance",
      "passed": true,
      "execution_time_seconds": 30.45,
      "frame_metrics": {
        "total_frames_processed": 915,
        "frame_drop_count": 0,
        "frame_accuracy_percentage": 100.0
      },
      "switching_metrics": {
        "successful_switches": 15,
        "average_switch_latency_ms": 2.3
      },
      "performance_metrics": {
        "average_fps": 30.1,
        "memory_usage_mb": 85.2,
        "cpu_usage_percent": 12.4
      }
    }
  ]
}
```

## Integration with CI/CD

The test system is designed for automated testing:

```bash
# Generate videos and run tests in CI environment
generate_test_videos.bat && build.bat --cmake && build/bin/Release/test_runner.exe --output ci_results.json
```

## Extending the Test System

### Adding New Test Types
1. Extend `TestRunner::RunSingleTest()` with new test type
2. Implement test logic in appropriate validator class
3. Add configuration options to `test_config.json`

### Adding New Video Patterns
1. Extend `FrameValidator::VideoPattern` enum
2. Implement pattern-specific validation logic
3. Update `generate_test_videos.bat` with new video generation

### Adding Custom Metrics
1. Extend `TestResult` struct with new metric fields
2. Update JSON serialization in `SaveResultsToJson()`
3. Implement metric collection in test execution

This testing framework provides comprehensive validation of the video player's core functionality while leveraging the existing synthetic test video infrastructure.